name: Create Plugin Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          
      - name: Validate plugin files
        run: |
          echo "Validating plugin structure..."
          if [ ! -f "giftcards-for-woocommerce/custom-giftcards-for-woocommerce.php" ]; then
            echo "‚ùå Main plugin file not found!"
            exit 1
          fi
          echo "‚úÖ Plugin structure validated"
          
      - name: Extract version from plugin header
        id: version
        run: |
          VERSION=$(grep "Version:" giftcards-for-woocommerce/custom-giftcards-for-woocommerce.php | sed 's/.*Version: //' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Plugin version: $VERSION"
          
      - name: Create plugin archive
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
          mkdir -p temp-release
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –ø–ª–∞–≥–∏–Ω–∞
          cp -r giftcards-for-woocommerce/* temp-release/
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏
          cd temp-release
          zip -r "../giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip" . \
            -x "*.git*" \
            -x "*.DS_Store*" \
            -x "*.log" \
            -x "node_modules/*" \
            -x "vendor/*" \
            -x ".vscode/*" \
            -x ".idea/*" \
            -x ".cursor/*"
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
          cd ..
          rm -rf temp-release
          
          echo "üì¶ Archive created: giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip"
          echo "üìÅ Archive structure verified:"
          unzip -l "giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip" | head -10
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Gift Cards Plugin v${{ steps.version.outputs.version }}
          body: |
            ## üéÅ WooCommerce Gift Cards Plugin v${{ steps.version.outputs.version }}
            
            ### üìã –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏:
            
            **üîí –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:**
            - –î–æ–±–∞–≤–ª–µ–Ω—ã nonce –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ –≤—Å–µ —Ñ–æ—Ä–º—ã
            - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç
            - –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã race conditions –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤
            
            **üéØ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
            - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
            - –£–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —Å—Ç–∞—Ç—É—Å–∞
            - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
            
            **üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
            - –£–ª—É—á—à–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å WooCommerce 5.0+
            - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –º–µ–ª–∫–∏–µ –æ—à–∏–±–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            
            ### üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
            1. –°–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ö–∏–≤
            2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤ `/wp-content/plugins/`
            3. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–ª–∞–≥–∏–Ω
            4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–æ–≤–∞—Ä—ã –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∫–∞—Ä—Ç
            
            ### üîó –°—Å—ã–ª–∫–∏:
            - [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://github.com/butuzoff/giftcards-for-woocommerce)
            - [–ü–æ–¥–¥–µ—Ä–∂–∫–∞](https://flancer.eu)
            - [–°–∞–π—Ç](https://lecharmie.com)
            
            ### üìù –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
            - WordPress 5.0+
            - WooCommerce 5.0+
            - PHP 7.4+
            
            ---
            **–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ [Flancer.eu](https://flancer.eu) —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è [LeCharmie.com](https://lecharmie.com)**
          draft: false
          prerelease: false
          
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip
          asset_name: giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip
          
      - name: Success notification
        run: |
          echo "üéâ Release v${{ steps.version.outputs.version }} created successfully!"
          echo "üì¶ Archive: giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip"
          echo "üîó Release URL: ${{ steps.create_release.outputs.upload_url }}"
