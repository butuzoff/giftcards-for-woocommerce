name: Create Plugin Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          
      - name: Validate plugin files
        run: |
          echo "Validating plugin structure..."
          if [ ! -f "custom-giftcards-for-woocommerce.php" ]; then
            echo "‚ùå Main plugin file not found!"
            exit 1
          fi
          echo "‚úÖ Plugin structure validated"
          
      - name: Extract version from plugin header
        id: version
        run: |
          VERSION=$(grep "Version:" custom-giftcards-for-woocommerce.php | sed 's/.*Version: //' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Plugin version: $VERSION"
          
      - name: Create plugin archive
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –ø–ª–∞–≥–∏–Ω–∞
          mkdir -p temp-release/giftcards-for-woocommerce
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–ª–∞–≥–∏–Ω–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          cp custom-giftcards-for-woocommerce.php temp-release/giftcards-for-woocommerce/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ readme.txt
          if [ -f "readme.txt" ]; then
            echo "‚úÖ readme.txt found, copying..."
            cp readme.txt temp-release/giftcards-for-woocommerce/
          else
            echo "‚ö†Ô∏è readme.txt not found, creating minimal version..."
            echo "=== Custom Gift Cards for WooCommerce ===" > temp-release/giftcards-for-woocommerce/readme.txt
            echo "Stable tag: ${{ steps.version.outputs.version }}" >> temp-release/giftcards-for-woocommerce/readme.txt
            echo "License: GPL v2 or later" >> temp-release/giftcards-for-woocommerce/readme.txt
          fi
          
          cp -r includes/ temp-release/giftcards-for-woocommerce/
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–ª—è WordPress
          cd temp-release
          zip -r "../giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip" . \
            -x "*.git*" \
            -x "*.DS_Store*" \
            -x "*.log" \
            -x "node_modules/*" \
            -x "vendor/*" \
            -x ".vscode/*" \
            -x ".idea/*" \
            -x ".cursor/*" \
            -x "README.md" \
            -x "RELEASE_*" \
            -x ".github/*"
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
          cd ..
          rm -rf temp-release
          
          echo "üì¶ Archive created: giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip"
          echo "üìÅ Archive structure verified:"
          unzip -l "giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip" | head -10
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Gift Cards Plugin v${{ steps.version.outputs.version }}
          body: |
            ## üéÅ WooCommerce Gift Cards Plugin v${{ steps.version.outputs.version }}
            
            ### üìã What's New in This Version:
            
            **üîí Security Enhancements:**
            - Added nonce validation to all forms
            - Implemented gift card expiration checks
            - Enhanced input data validation
            - Fixed race conditions in balance deductions
            
            **üéØ New Features:**
            - Support for partial gift card usage
            - Improved interface with status indicators
            - Mobile-responsive design
            - Detailed operation logging
            
            **üêõ Bug Fixes:**
            - Enhanced WooCommerce 5.0+ compatibility
            - Performance optimizations
            - Minor interface improvements
            
            ### üì¶ Installation:
            1. Download the archive
            2. Upload to `/wp-content/plugins/`
            3. Activate the plugin
            4. Configure gift card products
            
            ### üîó Links:
            - [Documentation](https://github.com/butuzoff/giftcards-for-woocommerce)
            - [Support](https://flancer.eu)
            - [Website](https://lecharmie.com)
            
            ### üìù Requirements:
            - WordPress 5.0+
            - WooCommerce 5.0+
            - PHP 7.4+
            
            ---
            **Developed by [Flancer.eu](https://flancer.eu) specifically for [LeCharmie.com](https://lecharmie.com)**
          draft: false
          prerelease: false
          
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip
          asset_name: giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip
          
      - name: Success notification
        run: |
          echo "üéâ Release v${{ steps.version.outputs.version }} created successfully!"
          echo "üì¶ Archive: giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip"
          echo "üîó Release URL: ${{ steps.create_release.outputs.upload_url }}"
