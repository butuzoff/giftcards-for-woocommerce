name: Create Plugin Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          
      - name: Validate plugin files
        run: |
          echo "Validating plugin structure..."
          if [ ! -f "custom-giftcards-for-woocommerce.php" ]; then
            echo "âŒ Main plugin file not found!"
            exit 1
          fi
          echo "âœ… Plugin structure validated"
          
      - name: Extract version from plugin header
        id: version
        run: |
          VERSION=$(grep "Version:" custom-giftcards-for-woocommerce.php | sed 's/.*Version: //' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Plugin version: $VERSION"
          
      - name: Create plugin archive
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°
          mkdir -p temp-release/giftcards-for-woocommerce
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ° Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ
          cp custom-giftcards-for-woocommerce.php temp-release/giftcards-for-woocommerce/
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ readme.txt
          if [ -f "readme.txt" ]; then
            echo "âœ… readme.txt found, copying..."
            cp readme.txt temp-release/giftcards-for-woocommerce/
          else
            echo "âš ï¸ readme.txt not found, creating minimal version..."
            echo "=== Custom Gift Cards for WooCommerce ===" > temp-release/giftcards-for-woocommerce/readme.txt
            echo "Stable tag: ${{ steps.version.outputs.version }}" >> temp-release/giftcards-for-woocommerce/readme.txt
            echo "License: GPL v2 or later" >> temp-release/giftcards-for-woocommerce/readme.txt
          fi
          
          cp -r includes/ temp-release/giftcards-for-woocommerce/
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°Ñ€Ñ…Ğ¸Ğ² Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¾Ğ¹ Ğ´Ğ»Ñ WordPress
          cd temp-release
          zip -r "../giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip" . \
            -x "*.git*" \
            -x "*.DS_Store*" \
            -x "*.log" \
            -x "node_modules/*" \
            -x "vendor/*" \
            -x ".vscode/*" \
            -x ".idea/*" \
            -x "README.md" \
            -x "RELEASE_*" \
            -x ".github/*"
          
          # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ
          cd ..
          rm -rf temp-release
          
          echo "ğŸ“¦ Archive created: giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip"
          echo "ğŸ“ Archive structure verified:"
          unzip -l "giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip" | head -10
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Gift Cards Plugin v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ WooCommerce Gift Cards Plugin v${{ steps.version.outputs.version }}
            
            ### ğŸ“‹ What's New in This Version:
            
            **ğŸ”’ Security Enhancements:**
            - Added nonce validation to all forms
            - Implemented gift card expiration checks
            - Enhanced input data validation
            - Fixed race conditions in balance deductions
            
            **ğŸ¯ New Features:**
            - Support for partial gift card usage
            - Improved interface with status indicators
            - Mobile-responsive design
            - Detailed operation logging
            
            **ğŸ› Bug Fixes:**
            - Enhanced WooCommerce 5.0+ compatibility
            - Performance optimizations
            - Minor interface improvements
            
            ### ğŸ“¦ Installation:
            1. Download the archive
            2. Upload to `/wp-content/plugins/`
            3. Activate the plugin
            4. Configure gift card products
            
            ### ğŸ”— Links:
            - [Documentation](https://github.com/butuzoff/giftcards-for-woocommerce)
            - [Support](https://flancer.eu)
       
            
            ### ğŸ“ Requirements:
            - WordPress 5.0+
            - WooCommerce 5.0+
            - PHP 7.4+
            
            ---
            **Developed by [Flancer.eu](https://flancer.eu)**
          draft: false
          prerelease: false
          
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip
          asset_name: giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip
          
      - name: Success notification
        run: |
          echo "ğŸ‰ Release v${{ steps.version.outputs.version }} created successfully!"
          echo "ğŸ“¦ Archive: giftcards-for-woocommerce-${{ steps.version.outputs.version }}.zip"
          echo "ğŸ”— Release URL: ${{ steps.create_release.outputs.upload_url }}"
